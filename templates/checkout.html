{% extends "base.html" %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Top Header -->
    <header class="dashboard-header">
        <div class="header-left">
            <h1>Checkout</h1>
            <p class="welcome-text">Complete your order</p>
        </div>
        <div class="header-right">
            <!-- ✅ LINE 12 UPDATED FOR CLOUDINARY -->
            <img src="{{ session.profile_pic }}" 
                 alt="Profile" class="profile-pic"
                 onerror="this.src='{{ url_for('static', filename='default-avatar.jpg') }}'">
        </div>
    </header>

    <!-- Checkout Form -->
    <main class="main-content">
        <form method="POST" action="{{ url_for('checkout') }}" class="checkout-form" id="checkoutForm">
            <input type="hidden" name="cart_items_json" id="cartItemsJson">
            
            <div class="form-section">
                <h3><i class="fas fa-user"></i> Contact Information</h3>
                
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" value="{{ session.full_name }}" readonly>
                </div>
                
                <div class="form-group">
                    <label>Mobile Number</label>
                    <input type="text" value="{{ session.phone }}" readonly>
                </div>
                
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" value="{{ session.email }}" readonly>
                </div>
                
                <div class="form-group">
                    <label>Registration Location</label>
                    <input type="text" value="{{ session.location }}" readonly>
                </div>
            </div>
            
            <div class="form-section">
                <h3><i class="fas fa-map-marker-alt"></i> Delivery Information</h3>
                
                <div class="form-group">
                    <label for="delivery_location">Delivery Location *</label>
                    <textarea id="delivery_location" name="delivery_location" rows="3" required placeholder="Enter complete address with landmark, city, pin code"></textarea>
                    <small>Enter the complete delivery address</small>
                </div>
                
                <div class="form-group">
                    <button type="button" class="btn btn-secondary btn-sm" onclick="useCurrentLocation()">
                        <i class="fas fa-location-crosshairs"></i> Use Current Location
                    </button>
                </div>
            </div>
            
            <div class="form-section">
                <h3><i class="fas fa-credit-card"></i> Payment Method</h3>
                
                <div class="payment-options">
                    <label class="payment-option">
                        <input type="radio" name="payment_mode" value="COD" required checked>
                        <div class="payment-content">
                            <i class="fas fa-money-bill-wave"></i>
                            <div>
                                <strong>Cash on Delivery</strong>
                                <small>Pay when you receive</small>
                            </div>
                        </div>
                    </label>
                    
                    <label class="payment-option">
                        <input type="radio" name="payment_mode" value="UPI">
                        <div class="payment-content">
                            <i class="fas fa-mobile-alt"></i>
                            <div>
                                <strong>UPI Payment</strong>
                                <small>Google Pay, PhonePe, etc.</small>
                            </div>
                        </div>
                    </label>
                    
                    <label class="payment-option">
                        <input type="radio" name="payment_mode" value="Card">
                        <div class="payment-content">
                            <i class="fas fa-credit-card"></i>
                            <div>
                                <strong>Card Payment</strong>
                                <small>Credit/Debit card</small>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- Order Summary -->
            <div class="form-section">
                <h3><i class="fas fa-receipt"></i> Order Summary</h3>
                <div class="order-summary">
                    <div class="summary-item">
                        <span>Subtotal</span>
                        <span id="cartSubtotal">Loading...</span>
                    </div>
                    <div class="summary-item">
                        <span>Delivery Charges</span>
                        <span>₹0.00</span>
                    </div>
                    <div class="summary-item">
                        <span>Taxes</span>
                        <span>₹0.00</span>
                    </div>
                    <div class="summary-item total">
                        <span><strong>Total Amount</strong></span>
                        <span><strong id="cartTotal">Loading...</strong></span>
                    </div>
                </div>
            </div>
            
            <div class="checkout-actions">
                <a href="{{ url_for('cart') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Cart
                </a>
                <button type="submit" class="btn btn-primary" id="confirmOrderBtn">
                    <i class="fas fa-check"></i> Confirm Order
                </button>
            </div>
        </form>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="{{ url_for('services') }}" class="nav-item">
            <i class="fas fa-concierge-bell"></i>
            <span>Services</span>
        </a>
        <a href="{{ url_for('menu') }}" class="nav-item">
            <i class="fas fa-utensils"></i>
            <span>Menu</span>
        </a>
        <a href="{{ url_for('cart') }}" class="nav-item">
            <i class="fas fa-shopping-cart"></i>
            <span>Cart</span>
        </a>
        <a href="{{ url_for('order_history') }}" class="nav-item">
            <i class="fas fa-history"></i>
            <span>Orders</span>
        </a>
        <a href="{{ url_for('profile') }}" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>
</div>

<script>
// Function to get cart items from server
async function getCartItems() {
    try {
        const response = await fetch('{{ url_for("cart") }}?json=1');
        if (!response.ok) throw new Error('Failed to fetch cart');
        
        const html = await response.text();
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Extract cart items from the page
        const cartItems = [];
        let totalAmount = 0;
        
        // Find cart items in the page
        const cartElements = doc.querySelectorAll('.cart-item, [data-item-type], .order-item');
        if (cartElements.length > 0) {
            cartElements.forEach(item => {
                const itemType = item.getAttribute('data-item-type') || 
                               item.querySelector('[data-type]')?.getAttribute('data-type') || 
                               'service';
                const itemId = item.getAttribute('data-item-id') || 
                             item.querySelector('[data-id]')?.getAttribute('data-id') || 
                             '1';
                const itemName = item.querySelector('.item-name, .product-name, [data-name]')?.textContent?.trim() || 
                               'Item';
                const quantity = parseInt(item.getAttribute('data-quantity') || 
                                        item.querySelector('.quantity')?.textContent || 
                                        '1');
                const price = parseFloat(item.getAttribute('data-price') || 
                                       item.querySelector('.price')?.textContent?.replace('₹', '') || 
                                       '0');
                
                cartItems.push({
                    item_type: itemType,
                    item_id: parseInt(itemId),
                    item_name: itemName,
                    quantity: quantity,
                    price: price
                });
                
                totalAmount += price * quantity;
            });
        } else {
            // Fallback: If no items found, use dummy data
            console.warn('No cart items found, using fallback');
            totalAmount = {{ cart_total|default(0) }};
        }
        
        return { cartItems, totalAmount };
    } catch (error) {
        console.error('Error fetching cart:', error);
        return { cartItems: [], totalAmount: 0 };
    }
}

// Function to update order summary
async function updateOrderSummary() {
    const { cartItems, totalAmount } = await getCartItems();
    
    // Update display
    document.getElementById('cartSubtotal').textContent = '₹' + totalAmount.toFixed(2);
    document.getElementById('cartTotal').textContent = '₹' + totalAmount.toFixed(2);
    
    // Store cart items in hidden field for form submission
    document.getElementById('cartItemsJson').value = JSON.stringify(cartItems);
    
    // Update button state
    const confirmBtn = document.getElementById('confirmOrderBtn');
    if (cartItems.length === 0) {
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = '<i class="fas fa-shopping-cart"></i> Cart is Empty';
        confirmBtn.classList.add('btn-disabled');
    } else {
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="fas fa-check"></i> Confirm Order';
        confirmBtn.classList.remove('btn-disabled');
    }
    
    return cartItems;
}

// Location functions
function useCurrentLocation() {
    if (!navigator.geolocation) {
        alert('Geolocation not supported by your browser');
        return;
    }
    
    const locationField = document.getElementById('delivery_location');
    locationField.placeholder = 'Getting location...';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            
            fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name || `${lat}, ${lon}`;
                    locationField.value = address;
                    locationField.placeholder = '';
                })
                .catch(() => {
                    locationField.value = `${lat}, ${lon}`;
                    locationField.placeholder = '';
                });
        },
        function(error) {
            let message = 'Unable to get location. ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += 'Permission denied';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += 'Position unavailable';
                    break;
                case error.TIMEOUT:
                    message += 'Request timeout';
                    break;
                default:
                    message += 'Unknown error';
            }
            alert(message);
            locationField.placeholder = 'Enter delivery address';
        }
    );
}

// Form validation and submission
document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const deliveryLocation = document.getElementById('delivery_location').value.trim();
    const paymentMode = document.querySelector('input[name="payment_mode"]:checked');
    
    if (!deliveryLocation) {
        alert('Please enter delivery location');
        document.getElementById('delivery_location').focus();
        return;
    }
    
    if (!paymentMode) {
        alert('Please select payment method');
        return;
    }
    
    const cartItems = await getCartItems();
    if (cartItems.cartItems.length === 0) {
        alert('Your cart is empty. Please add items before checkout.');
        window.location.href = '{{ url_for("cart") }}';
        return;
    }
    
    // Show loading state
    const submitBtn = document.getElementById('confirmOrderBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    submitBtn.disabled = true;
    
    // Submit the form
    this.submit();
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateOrderSummary();
    
    // Auto-populate delivery location with user's registered location
    const deliveryField = document.getElementById('delivery_location');
    const userLocation = "{{ session.location|default('') }}";
    if (userLocation && !deliveryField.value) {
        deliveryField.value = userLocation;
    }
});

// Add some styles for better UX
const style = document.createElement('style');
style.textContent = `
    .order-summary {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
    }
    
    .summary-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px dashed #dee2e6;
    }
    
    .summary-item:last-child {
        border-bottom: none;
    }
    
    .summary-item.total {
        font-size: 1.1em;
        border-top: 2px solid #dee2e6;
        margin-top: 10px;
        padding-top: 15px;
    }
    
    .btn-disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    #delivery_location:invalid {
        border-color: #dc3545;
    }
    
    #delivery_location:valid {
        border-color: #28a745;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}