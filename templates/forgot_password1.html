{% extends "base.html" %}

{% block title %}Forgot Password - Bite Me Buddy{% endblock %}

{% block head %}
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>

<style>
    /* ========== MAIN STYLES ========== */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .forgot-password-body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
    }

    .container {
        width: 100%;
        max-width: 450px;
    }

    .card {
        background: white;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        animation: fadeIn 0.5s ease-out;
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .card-header {
        background: linear-gradient(90deg, #4f46e5, #7c3aed);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .card-header h1 {
        font-size: 28px;
        font-weight: 600;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
    }

    .card-header p {
        opacity: 0.9;
        font-size: 15px;
    }

    .card-body {
        padding: 35px;
    }

    /* ========== STEP INDICATOR ========== */
    .step-indicator {
        display: flex;
        justify-content: space-between;
        margin-bottom: 30px;
        position: relative;
    }

    .step-indicator::before {
        content: '';
        position: absolute;
        top: 50%;
        left: 10%;
        right: 10%;
        height: 2px;
        background: #e5e7eb;
        transform: translateY(-50%);
        z-index: 1;
    }

    .step {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: white;
        border: 3px solid #e5e7eb;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #9ca3af;
        position: relative;
        z-index: 2;
        transition: all 0.3s;
    }

    .step.active {
        border-color: #4f46e5;
        background: #4f46e5;
        color: white;
        transform: scale(1.1);
    }

    .step.completed {
        border-color: #10b981;
        background: #10b981;
        color: white;
    }

    /* ========== FORM STYLES ========== */
    .form-group {
        margin-bottom: 24px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #374151;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .phone-input-row {
        display: flex;
        align-items: center;
        gap: 10px;
        background: #f8fafc;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        padding: 5px 15px;
        transition: all 0.3s;
    }

    .phone-input-row:focus-within {
        border-color: #4f46e5;
        background: white;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .country-code {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 0;
        min-width: 90px;
        color: #4f46e5;
        font-weight: 600;
        font-size: 16px;
    }

    .country-code i {
        font-size: 16px;
    }

    .divider {
        width: 1px;
        height: 30px;
        background: #e5e7eb;
    }

    .phone-input {
        flex: 1;
    }

    .phone-input input {
        width: 100%;
        padding: 12px 0;
        border: none;
        background: transparent;
        font-size: 16px;
        outline: none;
        color: #374151;
    }

    .phone-input input::placeholder {
        color: #9ca3af;
    }

    .form-control {
        width: 100%;
        padding: 14px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 16px;
        transition: all 0.3s;
        outline: none;
    }

    .form-control:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .form-control.error {
        border-color: #ef4444;
    }

    /* ========== BUTTON STYLES ========== */
    .btn {
        display: block;
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }

    .btn-primary {
        background: linear-gradient(90deg, #4f46e5, #7c3aed);
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 7px 14px rgba(79, 70, 229, 0.25);
    }

    .btn-primary:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }

    .btn-secondary {
        background: #f3f4f6;
        color: #374151;
        margin-top: 15px;
    }

    .btn-secondary:hover {
        background: #e5e7eb;
    }

    /* ========== OTP BOX STYLES ========== */
    .otp-box {
        background: #f8fafc;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        border-left: 4px solid #4f46e5;
        animation: slideDown 0.4s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .otp-inputs {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin: 20px 0;
    }

    .otp-digit {
        width: 50px;
        height: 60px;
        text-align: center;
        font-size: 24px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background: white;
        outline: none;
        transition: all 0.3s;
        font-weight: bold;
    }

    .otp-digit:focus {
        border-color: #4f46e5;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .otp-timer {
        text-align: center;
        margin-top: 15px;
        font-size: 14px;
        color: #6b7280;
    }

    .otp-timer span {
        font-weight: 600;
        color: #ef4444;
    }

    .resend-otp {
        text-align: center;
        margin-top: 10px;
    }

    .resend-otp a {
        color: #4f46e5;
        text-decoration: none;
        font-weight: 500;
        cursor: pointer;
    }

    .resend-otp a:hover {
        text-decoration: underline;
    }

    /* ========== PASSWORD STRENGTH ========== */
    .password-strength {
        margin-top: 8px;
        height: 5px;
        background: #e5e7eb;
        border-radius: 3px;
        overflow: hidden;
    }

    .strength-meter {
        height: 100%;
        width: 0;
        border-radius: 3px;
        transition: width 0.3s, background 0.3s;
    }

    /* ========== ALERT STYLES ========== */
    .alert {
        padding: 12px 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .alert-success {
        background: #d1fae5;
        color: #065f46;
        border-left: 4px solid #10b981;
    }

    .alert-error {
        background: #fee2e2;
        color: #991b1b;
        border-left: 4px solid #ef4444;
    }

    .alert i {
        font-size: 18px;
    }

    /* ========== ERROR MESSAGES ========== */
    .error-message {
        color: #ef4444;
        font-size: 13px;
        margin-top: 5px;
        display: flex;
        align-items: center;
        gap: 5px;
        display: none;
    }

    .error-message.show {
        display: flex;
    }

    /* ========== FOOTER LINKS ========== */
    .footer-links {
        text-align: center;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #e5e7eb;
    }

    .footer-links a {
        color: #6b7280;
        text-decoration: none;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .footer-links a:hover {
        color: #4f46e5;
    }

    /* ========== UTILITY CLASSES ========== */
    .hidden {
        display: none !important;
    }

    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .paste-hint {
        text-align: center;
        margin: 10px 0 20px;
        padding: 10px;
        background: #f0f9ff;
        border-radius: 8px;
        color: #0369a1;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
    }

    .mt-2 {
        margin-top: 8px;
    }

    /* ========== RECAPTCHA CONTAINER ========== */
    #recaptcha-container {
        margin: 15px 0;
        min-height: 50px;
    }

    /* ========== RESPONSIVE DESIGN ========== */
    @media (max-width: 480px) {
        .card-body {
            padding: 25px;
        }
        
        .card-header {
            padding: 25px 20px;
        }
        
        .card-header h1 {
            font-size: 24px;
        }
        
        .otp-digit {
            width: 45px;
            height: 55px;
            font-size: 22px;
        }
        
        .btn {
            padding: 14px;
            font-size: 15px;
        }
        
        .step {
            width: 35px;
            height: 35px;
            font-size: 14px;
        }
    }

    /* ========== SMALL SCREEN FIXES ========== */
    @media (max-width: 360px) {
        .card-body {
            padding: 20px;
        }
        
        .otp-digit {
            width: 40px;
            height: 50px;
            font-size: 20px;
        }
        
        .phone-input-row {
            padding: 5px 10px;
        }
        
        .country-code {
            min-width: 70px;
            font-size: 14px;
        }
    }

    /* ========== FORM VALIDATION STATES ========== */
    .input-success {
        border-color: #10b981 !important;
    }

    .input-error {
        border-color: #ef4444 !important;
    }

    /* ========== DISABLED STATES ========== */
    .disabled {
        opacity: 0.6;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* ========== LOADING OVERLAY ========== */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        display: none;
    }

    .loading-overlay.active {
        display: flex;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #e5e7eb;
        border-top-color: #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* ========== SUCCESS CHECKMARK ========== */
    .checkmark {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: block;
        stroke-width: 2;
        stroke: #fff;
        stroke-miterlimit: 10;
        margin: 10% auto;
        box-shadow: inset 0px 0px 0px #10b981;
        animation: fill .4s ease-in-out .4s forwards, scale .3s ease-in-out .9s both;
    }

    .checkmark-circle {
        stroke-dasharray: 166;
        stroke-dashoffset: 166;
        stroke-width: 2;
        stroke-miterlimit: 10;
        stroke: #10b981;
        fill: none;
        animation: stroke 0.6s cubic-bezier(0.65, 0, 0.45, 1) forwards;
    }

    .checkmark-check {
        transform-origin: 50% 50%;
        stroke-dasharray: 48;
        stroke-dashoffset: 48;
        animation: stroke 0.3s cubic-bezier(0.65, 0, 0.45, 1) 0.8s forwards;
    }

    @keyframes stroke {
        100% {
            stroke-dashoffset: 0;
        }
    }

    @keyframes scale {
        0%, 100% {
            transform: none;
        }
        50% {
            transform: scale3d(1.1, 1.1, 1);
        }
    }

    @keyframes fill {
        100% {
            box-shadow: inset 0px 0px 0px 30px #10b981;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="forgot-password-body">
    <div class="container">
        <div class="card">
            <div class="card-header">
                <h1><i class="fas fa-key"></i> Reset Password</h1>
                <p>Enter your mobile number to receive OTP</p>
            </div>

            <div class="card-body">
                <!-- Step Indicator -->
                <div class="step-indicator">
                    <div class="step active">1</div>
                    <div class="step">2</div>
                    <div class="step">3</div>
                </div>

                <!-- Alert Messages -->
                <div id="alertSuccess" class="alert alert-success hidden">
                    <i class="fas fa-check-circle"></i>
                    <span id="successText">Success message here</span>
                </div>

                <div id="alertError" class="alert alert-error hidden">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorText">Error message here</span>
                </div>

                <!-- Main Form -->
                <form id="resetForm" method="POST" action="/reset-password">
                    <!-- Hidden fields -->
                    <input type="hidden" id="fullMobile" name="mobile">
                    
                    <!-- Step 1: Mobile Number -->
                    <div id="step1">
                        <div class="paste-hint">
                            <i class="fas fa-paste"></i>
                            Just paste your 10-digit mobile number
                        </div>
                        
                        <div class="form-group">
                            <label><i class="fas fa-mobile-alt"></i> Mobile Number</label>
                            <div class="phone-input-row">
                                <div class="country-code">
                                    <i class="fas fa-flag"></i>
                                    <span>+91</span>
                                </div>
                                <div class="divider"></div>
                                <div class="phone-input">
                                    <input type="tel" 
                                           id="phoneNumber" 
                                           placeholder="Enter 10-digit number"
                                           autocomplete="off"
                                           inputmode="numeric"
                                           maxlength="10">
                                </div>
                            </div>
                            <small style="color: #6b7280; display: block; margin-top: 5px;">
                                Country code is auto-selected as +91 (India)
                            </small>
                        </div>

                        <!-- reCAPTCHA Container (Firebase needs this) -->
                        <div id="recaptcha-container"></div>

                        <button type="button" class="btn btn-primary" onclick="sendOTP()" id="sendOtpBtn">
                            <span id="btnText">Send OTP</span>
                            <span id="btnLoading" class="hidden"><i class="fas fa-spinner fa-spin"></i> Sending OTP...</span>
                        </button>
                    </div>

                    <!-- Step 2: OTP Verification -->
                    <div id="step2" class="hidden">
                        <div class="otp-box">
                            <div class="form-group">
                                <label><i class="fas fa-shield-alt"></i> Enter OTP</label>
                                <div style="text-align: center; margin-bottom: 15px; padding: 10px; background: #f0f9ff; border-radius: 8px;">
                                    <small style="color: #0369a1;">OTP sent to: <strong id="otpSentTo"></strong></small>
                                </div>
                                <div class="otp-inputs">
                                    <input type="text" class="otp-digit" id="otp1" maxlength="1" oninput="moveToNext(1, event)" onkeypress="return isNumberKey(event)">
                                    <input type="text" class="otp-digit" id="otp2" maxlength="1" oninput="moveToNext(2, event)" onkeypress="return isNumberKey(event)">
                                    <input type="text" class="otp-digit" id="otp3" maxlength="1" oninput="moveToNext(3, event)" onkeypress="return isNumberKey(event)">
                                    <input type="text" class="otp-digit" id="otp4" maxlength="1" oninput="moveToNext(4, event)" onkeypress="return isNumberKey(event)">
                                    <input type="text" class="otp-digit" id="otp5" maxlength="1" oninput="moveToNext(5, event)" onkeypress="return isNumberKey(event)">
                                    <input type="text" class="otp-digit" id="otp6" maxlength="1" oninput="moveToNext(6, event)" onkeypress="return isNumberKey(event)">
                                </div>
                                <input type="hidden" id="otp" name="otp">
                            </div>

                            <div class="otp-timer">
                                OTP expires in: <span id="countdown">02:00</span>
                            </div>

                            <div class="resend-otp">
                                Didn't receive OTP? <a href="javascript:void(0)" onclick="resendOTP()" id="resendLink">Resend OTP</a>
                                <span id="resendTimer" class="hidden"> (Wait <span id="waitTime">30</span>s)</span>
                            </div>
                        </div>

                        <button type="button" class="btn btn-secondary" onclick="goToStep(1)">
                            <i class="fas fa-arrow-left"></i> Change Number
                        </button>
                        
                        <button type="button" class="btn btn-primary mt-2" onclick="verifyOTP()" id="verifyOtpBtn">
                            <span id="verifyBtnText">Verify OTP</span>
                            <span id="verifyBtnLoading" class="hidden"><i class="fas fa-spinner fa-spin"></i> Verifying...</span>
                        </button>
                    </div>

                    <!-- Step 3: New Password -->
                    <div id="step3" class="hidden">
                        <div class="form-group">
                            <label for="password"><i class="fas fa-lock"></i> New Password</label>
                            <input type="password" 
                                   id="password" 
                                   name="password" 
                                   class="form-control" 
                                   placeholder="Enter new password" 
                                   required
                                   minlength="6"
                                   oninput="checkPasswordStrength(this.value)">
                            <div class="password-strength">
                                <div id="strengthMeter" class="strength-meter"></div>
                            </div>
                            <small style="color: #6b7280; display: block; margin-top: 5px;">
                                Minimum 6 characters with letters and numbers
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword"><i class="fas fa-lock"></i> Confirm Password</label>
                            <input type="password" 
                                   id="confirmPassword" 
                                   name="confirm_password"
                                   class="form-control" 
                                   placeholder="Confirm new password" 
                                   required
                                   minlength="6">
                            <div id="passwordMismatchError" class="error-message">
                                <i class="fas fa-times-circle"></i>
                                <span>Passwords do not match</span>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary" id="resetBtn">
                                <span id="resetBtnText">Reset Password</span>
                                <span id="resetBtnLoading" class="hidden"><i class="fas fa-spinner fa-spin"></i> Resetting...</span>
                            </button>
                        </div>

                        <button type="button" class="btn btn-secondary" onclick="goToStep(2)">
                            <i class="fas fa-arrow-left"></i> Back to OTP
                        </button>
                    </div>
                </form>

                <div class="footer-links">
                    <a href="/login"><i class="fas fa-arrow-left"></i> Back to Login</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ==================== FIREBASE CONFIGURATION ====================
    const firebaseConfig = {
        apiKey: "{{ FIREBASE_API_KEY }}",
        authDomain: "{{ FIREBASE_AUTH_DOMAIN }}",
        projectId: "{{ FIREBASE_PROJECT_ID }}",
        appId: "{{ FIREBASE_APP_ID }}"
    };
    
    // Initialize Firebase
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    // Firebase OTP variables
    let confirmationResult = null;
    let recaptchaVerifier = null;
    let resendTimerInterval = null;
    let canResendOTP = true;
    
    // ==================== APPLICATION VARIABLES ====================
    let currentStep = 1;
    let timer;
    let timeLeft = 120;
    let currentPhoneNumber = '';
    
    // ==================== HELPER FUNCTIONS ====================
    
    // Initialize steps
    function updateStepIndicator() {
        document.querySelectorAll('.step').forEach((step, index) => {
            step.classList.remove('active', 'completed');
            if (index + 1 < currentStep) {
                step.classList.add('completed');
            } else if (index + 1 === currentStep) {
                step.classList.add('active');
            }
        });
    }
    
    // Show specific step
    function goToStep(stepNumber) {
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step3').classList.add('hidden');
        
        document.getElementById(`step${stepNumber}`).classList.remove('hidden');
        
        currentStep = stepNumber;
        updateStepIndicator();
    }
    
    // Show alert
    function showAlert(type, message) {
        document.getElementById('alertSuccess').classList.add('hidden');
        document.getElementById('alertError').classList.add('hidden');
        
        if (type === 'success') {
            const alertEl = document.getElementById('alertSuccess');
            document.getElementById('successText').textContent = message;
            alertEl.classList.remove('hidden');
        } else {
            const alertEl = document.getElementById('alertError');
            document.getElementById('errorText').textContent = message;
            alertEl.classList.remove('hidden');
        }
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            document.getElementById('alertSuccess').classList.add('hidden');
            document.getElementById('alertError').classList.add('hidden');
        }, 5000);
    }
    
    // Show loading overlay
    function showLoading() {
        document.getElementById('loadingOverlay').classList.add('active');
    }
    
    // Hide loading overlay
    function hideLoading() {
        document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    // Validate phone number
    function isNumberKey(evt) {
        const charCode = (evt.which) ? evt.which : evt.keyCode;
        if (charCode > 31 && (charCode < 48 || charCode > 57)) {
            return false;
        }
        return true;
    }
    
    // Clean phone number input
    function cleanPhoneNumber(input) {
        let clean = input.replace(/\D/g, '');
        
        if (clean.startsWith('91') && clean.length > 10) {
            clean = clean.substring(2);
        }
        
        if (clean.startsWith('0') && clean.length > 10) {
            clean = clean.substring(1);
        }
        
        clean = clean.substring(clean.length - 10);
        
        return clean;
    }
    
    // Format phone number
    function formatPhoneNumber() {
        const input = document.getElementById('phoneNumber');
        let value = input.value;
        
        let clean = cleanPhoneNumber(value);
        input.value = clean;
        
        if (clean.length === 10) {
            currentPhoneNumber = '+91' + clean;
            document.getElementById('fullMobile').value = currentPhoneNumber;
            return clean;
        }
        
        return null;
    }
    
    // Start OTP countdown timer
    function startTimer() {
        clearInterval(timer);
        timeLeft = 120;
        
        timer = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            
            document.getElementById('countdown').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                document.getElementById('countdown').textContent = "00:00";
                showAlert('error', 'OTP has expired. Please request a new OTP.');
            }
        }, 1000);
    }
    
    // Start resend timer
    function startResendTimer(seconds = 30) {
        canResendOTP = false;
        document.getElementById('resendLink').style.pointerEvents = 'none';
        document.getElementById('resendLink').style.opacity = '0.5';
        document.getElementById('resendTimer').classList.remove('hidden');
        
        let waitTime = seconds;
        document.getElementById('waitTime').textContent = waitTime;
        
        resendTimerInterval = setInterval(() => {
            waitTime--;
            document.getElementById('waitTime').textContent = waitTime;
            
            if (waitTime <= 0) {
                clearInterval(resendTimerInterval);
                canResendOTP = true;
                document.getElementById('resendLink').style.pointerEvents = 'auto';
                document.getElementById('resendLink').style.opacity = '1';
                document.getElementById('resendTimer').classList.add('hidden');
            }
        }, 1000);
    }
    
    // Password strength checker
    function checkPasswordStrength(password) {
        const meter = document.getElementById('strengthMeter');
        let strength = 0;
        
        if (password.length >= 6) strength += 25;
        if (/[A-Z]/.test(password)) strength += 25;
        if (/[0-9]/.test(password)) strength += 25;
        if (/[^A-Za-z0-9]/.test(password)) strength += 25;
        
        meter.style.width = strength + '%';
        
        if (strength < 50) {
            meter.style.background = '#ef4444';
        } else if (strength < 75) {
            meter.style.background = '#f59e0b';
        } else {
            meter.style.background = '#10b981';
        }
    }
    
    // Check if passwords match
    function checkPasswordsMatch() {
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const errorElement = document.getElementById('passwordMismatchError');
        
        // Reset error state
        errorElement.classList.remove('show');
        document.getElementById('password').classList.remove('error');
        document.getElementById('confirmPassword').classList.remove('error');
        
        // Only check if both fields have values
        if (password && confirmPassword) {
            if (password !== confirmPassword) {
                errorElement.classList.add('show');
                document.getElementById('password').classList.add('error');
                document.getElementById('confirmPassword').classList.add('error');
                return false;
            }
        }
        
        return true;
    }
    
    // OTP input navigation
    function moveToNext(current, event) {
        const input = event.target;
        const nextId = `otp${parseInt(current) + 1}`;
        const prevId = `otp${parseInt(current) - 1}`;
        
        // Allow only numbers
        input.value = input.value.replace(/\D/g, '');
        
        if (input.value.length === 1 && current < 6) {
            document.getElementById(nextId).focus();
        }
        
        if (input.value.length === 0 && current > 1 && event.inputType === 'deleteContentBackward') {
            document.getElementById(prevId).focus();
        }
        
        combineOTP();
    }
    
    // Combine OTP digits
    function combineOTP() {
        let otp = '';
        for (let i = 1; i <= 6; i++) {
            otp += document.getElementById(`otp${i}`).value;
        }
        document.getElementById('otp').value = otp;
    }
    
    // Clear OTP inputs
    function clearOTPInputs() {
        for (let i = 1; i <= 6; i++) {
            document.getElementById(`otp${i}`).value = '';
        }
        document.getElementById('otp').value = '';
    }
    
    // ==================== FIREBASE OTP FUNCTIONS ====================
    
    // Send OTP via Firebase
    window.sendOTP = function () {
        const phoneNumber = formatPhoneNumber();
        
        if (!phoneNumber || phoneNumber.length !== 10) {
            showAlert('error', 'Please enter a valid 10-digit mobile number');
            return;
        }
        
        const fullMobile = '+91' + phoneNumber;
        currentPhoneNumber = fullMobile;
        
        // UI changes
        document.getElementById('btnText').classList.add('hidden');
        document.getElementById('btnLoading').classList.remove('hidden');
        document.getElementById('sendOtpBtn').disabled = true;
        
        document.getElementById('otpSentTo').textContent = fullMobile;
        
        // Setup reCAPTCHA for Firebase
        if (!recaptchaVerifier) {
            recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', {
                'size': 'invisible',
                'callback': function(response) {
                    console.log("reCAPTCHA verified successfully");
                },
                'expired-callback': function() {
                    console.log("reCAPTCHA expired");
                    recaptchaVerifier = null;
                }
            });
        }
        
        // Show loading
        showLoading();
        
        // Send OTP via Firebase
        auth.signInWithPhoneNumber(fullMobile, recaptchaVerifier)
            .then(function(confirmation) {
                confirmationResult = confirmation;
                
                hideLoading();
                showAlert('success', 'OTP sent successfully! Check your phone for verification code.');
                
                // Move to OTP step
                setTimeout(() => {
                    goToStep(2);
                    startTimer();
                    startResendTimer(30);
                    clearOTPInputs();
                    document.getElementById('btnText').classList.remove('hidden');
                    document.getElementById('btnLoading').classList.add('hidden');
                    document.getElementById('sendOtpBtn').disabled = false;
                    document.getElementById('otp1').focus();
                }, 1000);
            })
            .catch(function(error) {
                hideLoading();
                console.error("Firebase OTP Error:", error);
                
                // Show user-friendly error messages
                let errorMessage = "Failed to send OTP. ";
                switch(error.code) {
                    case 'auth/invalid-phone-number':
                        errorMessage = "Invalid phone number format. Please enter a valid 10-digit number.";
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = "Too many attempts. Please try again later.";
                        break;
                    case 'auth/quota-exceeded':
                        errorMessage = "SMS quota exceeded. Please try again in some time.";
                        break;
                    case 'auth/captcha-check-failed':
                        errorMessage = "Security check failed. Please refresh the page and try again.";
                        break;
                    default:
                        errorMessage = "Failed to send OTP. Please try again.";
                }
                
                showAlert('error', errorMessage);
                document.getElementById('btnText').classList.remove('hidden');
                document.getElementById('btnLoading').classList.add('hidden');
                document.getElementById('sendOtpBtn').disabled = false;
                
                // Reset recaptcha on error
                recaptchaVerifier = null;
            });
    }
    
    // Verify OTP with Firebase
    function verifyOTP() {
        const otp = document.getElementById('otp').value;
        
        // Check OTP length
        if (!otp || otp.length !== 6) {
            showAlert('error', 'Please enter a valid 6-digit OTP');
            document.getElementById('otp1').focus();
            return;
        }
        
        // UI changes
        document.getElementById('verifyBtnText').classList.add('hidden');
        document.getElementById('verifyBtnLoading').classList.remove('hidden');
        document.getElementById('verifyOtpBtn').disabled = true;
        
        // Show loading
        showLoading();
        
        // Verify OTP with Firebase
        if (!confirmationResult) {
            hideLoading();
            showAlert('error', 'OTP session expired. Please request OTP again.');
            goToStep(1);
            return;
        }
        
        confirmationResult.confirm(otp)
            .then(function(result) {
                // OTP verified successfully
                hideLoading();
                showAlert('success', 'OTP verified successfully!');
                
                // Store verification in session via backend
                fetch('/verify-otp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        mobile: currentPhoneNumber,
                        otp: otp
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Move to password reset step
                        setTimeout(() => {
                            goToStep(3);
                            document.getElementById('verifyBtnText').classList.remove('hidden');
                            document.getElementById('verifyBtnLoading').classList.add('hidden');
                            document.getElementById('verifyOtpBtn').disabled = false;
                            document.getElementById('password').focus();
                        }, 1000);
                    } else {
                        showAlert('error', data.message || 'OTP verification failed');
                        document.getElementById('verifyBtnText').classList.remove('hidden');
                        document.getElementById('verifyBtnLoading').classList.add('hidden');
                        document.getElementById('verifyOtpBtn').disabled = false;
                    }
                })
                .catch(error => {
                    hideLoading();
                    console.error('Backend error:', error);
                    showAlert('error', 'Server error. Please try again.');
                    document.getElementById('verifyBtnText').classList.remove('hidden');
                    document.getElementById('verifyBtnLoading').classList.add('hidden');
                    document.getElementById('verifyOtpBtn').disabled = false;
                });
                
            })
            .catch(function(error) {
                hideLoading();
                console.error("OTP Verification Error:", error);
                
                // Hide loading state
                document.getElementById('verifyBtnText').classList.remove('hidden');
                document.getElementById('verifyBtnLoading').classList.add('hidden');
                document.getElementById('verifyOtpBtn').disabled = false;
                
                // Show error message
                let errorMessage = "Invalid OTP. ";
                if (error.code === 'auth/invalid-verification-code') {
                    errorMessage = "The OTP you entered is incorrect. Please try again.";
                } else if (error.code === 'auth/code-expired') {
                    errorMessage = "OTP has expired. Please request a new OTP.";
                    goToStep(1);
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Too many incorrect attempts. Please try again later.";
                }
                
                showAlert('error', errorMessage);
                clearOTPInputs();
                document.getElementById('otp1').focus();
            });
    }
    
    // Resend OTP function
    function resendOTP() {
        if (!canResendOTP) {
            return;
        }
        
        clearInterval(timer);
        clearOTPInputs();
        sendOTP();
    }
    
    // Form submission handler
    document.getElementById('resetForm').addEventListener('submit', function(e) {
        // Check if passwords match
        if (!checkPasswordsMatch()) {
            e.preventDefault();
            showAlert('error', 'Passwords do not match. Please check and try again.');
            return;
        }
        
        // Show loading state
        document.getElementById('resetBtnText').classList.add('hidden');
        document.getElementById('resetBtnLoading').classList.remove('hidden');
        document.getElementById('resetBtn').disabled = true;
        
        // Show loading overlay
        showLoading();
    });
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        updateStepIndicator();
        
        // Phone number input listener
        document.getElementById('phoneNumber').addEventListener('input', formatPhoneNumber);
        
        // Paste listener for phone number
        document.getElementById('phoneNumber').addEventListener('paste', function(e) {
            setTimeout(formatPhoneNumber, 10);
        });
        
        // Password match checker
        document.getElementById('confirmPassword').addEventListener('input', function() {
            checkPasswordsMatch();
        });
        
        // Enter key to send OTP
        document.getElementById('phoneNumber').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendOTP();
            }
        });
        
        // Enter key to verify OTP
        for (let i = 1; i <= 6; i++) {
            document.getElementById(`otp${i}`).addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    verifyOTP();
                }
            });
        }
        
        // Auto-focus phone input
        document.getElementById('phoneNumber').focus();
        
        // Log Firebase status
        console.log("Firebase initialized:", firebaseConfig.apiKey ? "Success" : "Failed");
    });
</script>
{% endblock %}